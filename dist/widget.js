!function(){"use strict";!function(t,e){void 0===e&&(e={});var i=e.insertAt;if("undefined"!=typeof document){var s=document.head||document.getElementsByTagName("head")[0],o=document.createElement("style");o.type="text/css","top"===i&&s.firstChild?s.insertBefore(o,s.firstChild):s.appendChild(o),o.styleSheet?o.styleSheet.cssText=t:o.appendChild(document.createTextNode(t))}}(".ai-widget-btn{align-items:center;background:linear-gradient(135deg,#667eea,#764ba2);border:none;border-radius:50%;bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,.15);cursor:pointer;display:flex;height:60px;justify-content:center;outline:none;position:fixed;right:20px;transition:all .3s cubic-bezier(.4,0,.2,1);width:60px;z-index:9999}.ai-widget-btn:hover{box-shadow:0 8px 16px rgba(0,0,0,.2);transform:scale(1.1) translateY(-2px)}.ai-widget-btn:active{transform:scale(1.05)}.ai-widget-modal{background:#fff;border-radius:16px;bottom:90px;box-shadow:0 10px 40px rgba(0,0,0,.2);display:flex;flex-direction:column;max-height:500px;opacity:0;overflow:hidden;pointer-events:none;position:fixed;right:20px;transform:translateY(20px);transition:all .3s cubic-bezier(.4,0,.2,1);width:350px;z-index:9998}.ai-widget-modal.visible{opacity:1;pointer-events:all;transform:translateY(0)}.modal-header{align-items:center;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;display:flex;justify-content:space-between;padding:16px 20px}.modal-header h3{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;font-size:16px;font-weight:600;margin:0}.close-btn{align-items:center;background:none;border:none;border-radius:4px;color:#fff;cursor:pointer;display:flex;font-size:28px;height:30px;justify-content:center;line-height:1;padding:0;transition:background .2s;width:30px}.close-btn:hover{background:hsla(0,0%,100%,.2)}.modal-body{align-items:center;display:flex;flex:1;flex-direction:column;gap:16px;min-height:250px;padding:24px 20px}#ai-widget-visualizer{background:linear-gradient(135deg,#f5f7fa,#e3e8ee);border-radius:12px;height:150px;width:100%}.status{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;text-align:center}.status-icon{display:block;font-size:32px;margin-bottom:8px}.status-text{color:#4a5568;font-size:14px;font-weight:500;margin:0}.modal-footer{border-top:1px solid #e2e8f0;display:flex;gap:12px;justify-content:center;padding:16px 20px}.btn{border:none;border-radius:8px;cursor:pointer;flex:1;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;font-size:14px;font-weight:600;outline:none;padding:12px 24px;transition:all .2s}.btn-primary{background:#667eea;color:#fff}.btn-primary:hover:not(:disabled){background:#5568d3;box-shadow:0 4px 8px rgba(102,126,234,.3);transform:translateY(-1px)}.btn-danger{background:#ef4444;color:#fff}.btn-danger:hover:not(:disabled){background:#dc2626;box-shadow:0 4px 8px rgba(239,68,68,.3);transform:translateY(-1px)}.btn:disabled{background:#cbd5e0;box-shadow:none;cursor:not-allowed;transform:none}.btn:active:not(:disabled){transform:translateY(0)}.ai-widget-toast{background:#fff;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;font-size:14px;max-width:350px;opacity:0;padding:16px 20px;pointer-events:none;position:fixed;right:20px;top:20px;transform:translateY(-10px);transition:all .3s cubic-bezier(.4,0,.2,1);z-index:10000}.ai-widget-toast.visible{opacity:1;transform:translateY(0)}.ai-widget-toast.error{background:#fee2e2;border-left:4px solid #ef4444;color:#991b1b}@media (max-width:768px){.ai-widget-modal{border-radius:0;bottom:0;height:100vh;left:0;max-height:100vh;max-width:100%;right:0;width:100%}.ai-widget-btn{bottom:16px;right:16px}.ai-widget-toast{left:16px;max-width:none;right:16px;top:16px}}");class t{constructor(t,e=!0){this.namespace=t,this.enabled=e}log(...t){this.enabled}error(...t){this.enabled}warn(...t){this.enabled}debug(...t){this.enabled}}class e{constructor(e){this.baseUrl=e,this.logger=new t("ApiClient")}async fetchConfig(t){try{const e=await fetch(`${this.baseUrl}/widget/config/${t}`);if(!e.ok){if(404===e.status)throw new Error("INVALID_KEY");if(403===e.status)throw new Error("KEY_INACTIVE");throw new Error("NETWORK_ERROR")}const i=await e.json();return this.logger.log("Fetched config:",i),i}catch(t){throw this.logger.error("Failed to fetch config:",t),t}}async sendOffer(t,e,i){try{const s=await fetch(`${this.baseUrl}/widget/offer`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({publicKey:t,domain:e,sdpOffer:i})});if(!s.ok){if(403===s.status)throw new Error("DOMAIN_NOT_ALLOWED");if(400===s.status){const t=await s.json();if(t.message?.includes("concurrent"))throw new Error("MAX_SESSIONS_REACHED")}throw new Error("NETWORK_ERROR")}const o=await s.json();return this.logger.log("Session created:",o.sessionId),o}catch(t){throw this.logger.error("Failed to send offer:",t),t}}async sendIceCandidate(t,e){try{await fetch(`${this.baseUrl}/widget/ice-candidate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:t,candidate:e})}),this.logger.debug("ICE candidate sent")}catch(t){this.logger.error("Failed to send ICE candidate:",t)}}async hangup(t){try{await fetch(`${this.baseUrl}/widget/hangup`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:t})}),this.logger.log("Session ended:",t)}catch(t){this.logger.error("Failed to send hangup:",t)}}}class i{constructor(){this.events={}}on(t,e){return this.events[t]||(this.events[t]=[]),this.events[t].push(e),()=>this.off(t,e)}off(t,e){this.events[t]&&(this.events[t]=this.events[t].filter(t=>t!==e))}emit(t,...e){this.events[t]&&this.events[t].forEach(t=>t(...e))}once(t,e){const i=(...s)=>{e(...s),this.off(t,i)};this.on(t,i)}}class s extends i{constructor(e){super(),this.api=e,this.pc=null,this.sessionId=null,this.localStream=null,this.logger=new t("WebRTC")}async startSession(t,e){try{this.logger.log("Requesting microphone access..."),this.localStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:48e3}}),this.emit("microphoneGranted",this.localStream),this.logger.log("Microphone access granted"),this.pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]}),this.localStream.getTracks().forEach(t=>{this.pc.addTrack(t,this.localStream),this.logger.debug("Added audio track:",t.label)}),this.pc.ontrack=t=>{this.logger.log("Received remote audio track");const e=new Audio;e.srcObject=t.streams[0],e.autoplay=!0,this.emit("audioReceived",t.streams[0])},this.pc.onicecandidate=async t=>{t.candidate&&(this.logger.debug("New ICE candidate"),await this.api.sendIceCandidate(this.sessionId,t.candidate))},this.pc.onconnectionstatechange=()=>{this.logger.log("Connection state:",this.pc.connectionState),"connected"===this.pc.connectionState?this.emit("connected"):"disconnected"!==this.pc.connectionState&&"failed"!==this.pc.connectionState||this.emit("disconnected")},this.logger.log("Creating SDP offer...");const i=await this.pc.createOffer();await this.pc.setLocalDescription(i),this.emit("connecting");const s=await this.api.sendOffer(t,e,i.sdp);this.sessionId=s.sessionId,await this.pc.setRemoteDescription({type:"answer",sdp:s.sdpAnswer}),this.logger.log("Session established:",this.sessionId)}catch(t){throw this.logger.error("Failed to start session:",t),"NotAllowedError"===t.name?this.emit("error","MICROPHONE_PERMISSION_DENIED"):"DOMAIN_NOT_ALLOWED"===t.message?this.emit("error","DOMAIN_NOT_ALLOWED"):"MAX_SESSIONS_REACHED"===t.message?this.emit("error","MAX_SESSIONS_REACHED"):this.emit("error","NETWORK_ERROR"),this.cleanup(),t}}async stopSession(){this.logger.log("Stopping session..."),this.sessionId&&await this.api.hangup(this.sessionId),this.cleanup(),this.emit("stopped")}cleanup(){this.pc&&(this.pc.close(),this.pc=null),this.localStream&&(this.localStream.getTracks().forEach(t=>t.stop()),this.localStream=null),this.sessionId=null}}class o extends i{constructor(){super(),this.button=this.create()}create(){const t=document.createElement("button");return t.className="ai-widget-btn",t.setAttribute("aria-label","Open aiPBX widget"),t.innerHTML='\n      <svg width="24" height="24" viewBox="0 0 24 24" fill="white">\n        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>\n        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>\n      </svg>\n    ',t.addEventListener("click",()=>this.emit("click")),t}show(){document.body.contains(this.button)||document.body.appendChild(this.button)}hide(){document.body.contains(this.button)&&this.button.remove()}destroy(){this.hide()}}class n{constructor(t){this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.analyser=null,this.animationId=null,this.audioContext=null}connect(t){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext);const e=this.audioContext.createMediaStreamSource(t);this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=128,this.analyser.smoothingTimeConstant=.8,e.connect(this.analyser),this.draw()}catch(t){}}draw(){if(this.animationId=requestAnimationFrame(()=>this.draw()),!this.analyser)return;const t=this.analyser.frequencyBinCount,e=new Uint8Array(t);this.analyser.getByteFrequencyData(e),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);const i=this.canvas.width/t*2.5;let s=0;for(let o=0;o<t;o++){const n=e[o]/255*this.canvas.height*.8,a=o/t*280+240;this.ctx.fillStyle=`hsl(${a}, 70%, 60%)`,this.ctx.beginPath(),this.ctx.roundRect(s,this.canvas.height-n,i-2,n,2),this.ctx.fill(),s+=i}}disconnect(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.analyser=null}}class a extends i{constructor(t){super(),this.config=t,this.modal=this.create(),this.visualizer=null}create(){const t=document.createElement("div");return t.className="ai-widget-modal",t.innerHTML=`\n      <div class="modal-header">\n        <h3>${this.config.assistantName||"aiPBX widget"}</h3>\n        <button class="close-btn" aria-label="Close">&times;</button>\n      </div>\n      <div class="modal-body">\n        <canvas id="ai-widget-visualizer" width="300" height="150"></canvas>\n        <div class="status">\n          <span class="status-icon">ðŸŽ¤</span>\n          <p class="status-text">Ready to talk...</p>\n        </div>\n      </div>\n      <div class="modal-footer">\n        <button class="btn btn-primary btn-start">Start</button>\n        <button class="btn btn-danger btn-stop" disabled>Stop</button>\n      </div>\n    `,t.querySelector(".close-btn").addEventListener("click",()=>{this.hide(),this.emit("close")}),t.querySelector(".btn-start").addEventListener("click",()=>{this.emit("start")}),t.querySelector(".btn-stop").addEventListener("click",()=>{this.emit("stop")}),t}show(){document.body.contains(this.modal)||document.body.appendChild(this.modal),setTimeout(()=>this.modal.classList.add("visible"),10)}hide(){this.modal.classList.remove("visible"),setTimeout(()=>{document.body.contains(this.modal)&&this.modal.remove()},300)}setStatus(t,e){const i=this.modal.querySelector(".status-text"),s=this.modal.querySelector(".status-icon"),o=this.modal.querySelector(".btn-start"),n=this.modal.querySelector(".btn-stop");switch(i.textContent=e,t){case"connecting":s.textContent="â³",o.disabled=!0,n.disabled=!0;break;case"connected":s.textContent="âœ…",o.disabled=!0,n.disabled=!1;break;case"error":s.textContent="âŒ",o.disabled=!1,n.disabled=!0;break;default:s.textContent="ðŸŽ¤",o.disabled=!1,n.disabled=!0}}attachVisualizer(t){const e=this.modal.querySelector("#ai-widget-visualizer");e&&(this.visualizer&&this.visualizer.disconnect(),this.visualizer=new n(e),this.visualizer.connect(t))}destroyVisualizer(){this.visualizer&&(this.visualizer.disconnect(),this.visualizer=null)}destroy(){this.destroyVisualizer(),this.hide()}}class r{constructor(i,n){this.publicKey=i,this.apiUrl=n,this.config=null,this.logger=new t("aiPBX widget"),this.api=new e(n),this.webrtc=new s(this.api),this.floatingButton=new o,this.modal=null,this.isSessionActive=!1}async init(){try{this.logger.log("Initializing widget with key:",this.publicKey),this.config=await this.api.fetchConfig(this.publicKey),this.logger.log("Configuration loaded:",this.config),this.modal=new a(this.config),this.setupEventListeners(),this.floatingButton.show(),this.exposePublicAPI(),this.logger.log("Widget initialized successfully")}catch(t){this.logger.error("Failed to initialize widget:",t),this.showError("Failed to initialize aiPBX widget. Please check your configuration.")}}setupEventListeners(){this.floatingButton.on("click",()=>{this.isSessionActive||this.modal.show()}),this.modal.on("close",()=>{this.isSessionActive&&this.stopSession()}),this.modal.on("start",()=>{this.startSession()}),this.modal.on("stop",()=>{this.stopSession()}),this.webrtc.on("connecting",()=>{this.modal.setStatus("connecting","Connecting...")}),this.webrtc.on("microphoneGranted",t=>{this.logger.log("Microphone granted, attaching visualizer"),this.modal.attachVisualizer(t)}),this.webrtc.on("connected",()=>{this.logger.log("Successfully connected"),this.modal.setStatus("connected","Connected! Start talking..."),this.isSessionActive=!0}),this.webrtc.on("audioReceived",t=>{this.logger.log("Receiving audio from AI")}),this.webrtc.on("disconnected",()=>{this.logger.log("Disconnected"),this.stopSession()}),this.webrtc.on("stopped",()=>{this.modal.setStatus("ready","Ready to talk..."),this.modal.destroyVisualizer(),this.isSessionActive=!1}),this.webrtc.on("error",t=>{this.handleError(t)})}async startSession(){try{const t=window.location.hostname;await this.webrtc.startSession(this.publicKey,t)}catch(t){this.logger.error("Failed to start session:",t)}}async stopSession(){try{await this.webrtc.stopSession()}catch(t){this.logger.error("Failed to stop session:",t)}}handleError(t){let e;switch(t){case"MICROPHONE_PERMISSION_DENIED":e="Please allow microphone access to use voice chat";break;case"NETWORK_ERROR":e="Connection failed. Please check your internet";break;case"INVALID_KEY":e="Widget configuration error. Please contact support";break;case"MAX_SESSIONS_REACHED":e="Service is busy. Please try again in a few minutes";break;case"DOMAIN_NOT_ALLOWED":e="This widget is not authorized for this domain";break;default:e="An error occurred. Please try again"}this.modal.setStatus("error",e),this.showError(e),this.isSessionActive=!1}showError(t){const e=document.createElement("div");e.className="ai-widget-toast error",e.textContent=t,document.body.appendChild(e),setTimeout(()=>e.classList.add("visible"),10),setTimeout(()=>{e.classList.remove("visible"),setTimeout(()=>e.remove(),300)},5e3)}exposePublicAPI(){window.aiPBXWidget={show:()=>this.modal.show(),hide:()=>this.modal.hide(),start:()=>this.startSession(),stop:()=>this.stopSession(),isActive:()=>this.isSessionActive}}destroy(){this.floatingButton.destroy(),this.modal&&this.modal.destroy(),this.isSessionActive&&this.stopSession()}}!function(){const t=document.currentScript;if(!t)return;const e=t.getAttribute("data-key"),i=t.getAttribute("data-api")||"http://localhost:3000";if(!e)return;const s=()=>{new r(e,i).init()};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",s):s()}()}();
